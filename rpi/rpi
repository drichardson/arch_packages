#!/usr/bin/python3
# PYTHON_ARGCOMPLETE_OK

import sys
import argparse
import subprocess
import os.path

# Conditional support for bash completion
try:
    import argcomplete
    has_argcomplete=True
except ImportError:
    has_argcomplete=False


RPI_MOUNT_DIR=os.path.expanduser("~/rpi_mnt")
RPI_MOUNT_ROOT=os.path.join(RPI_MOUNT_DIR, "root")
RPI_MOUNT_BOOT=os.path.join(RPI_MOUNT_DIR, "boot")
SD_CARD_BOOT_PARTITION="/dev/sdc1"
SD_CARD_ROOT_PARTITION="/dev/sdc2"
KERNEL_SRC=os.path.expanduser("~/control_linux")
RASPBERRYPI_TOOLS=os.path.expanduser("~/raspberrypi-tools")
CCPREFIX=os.path.expanduser("~/x-tools6h/arm-unknown-linux-gnueabihf/bin/arm-unknown-linux-gnueabihf-")

def true_or_die(condition, message):
    if not condition:
        print("ERROR: ", message, file=sys.stderr)
        sys.exit(1)

def sudo(argv):
    a=["/usr/bin/sudo"]
    a.extend(argv)
    return subprocess.call(a)

def mount(args):
    print("Mounting SD card partitions")
    rc1 = sudo(["/usr/bin/mount", SD_CARD_BOOT_PARTITION, RPI_MOUNT_BOOT])
    rc2 = sudo(["/usr/bin/mount", SD_CARD_ROOT_PARTITION, RPI_MOUNT_ROOT])
    true_or_die(rc1 == 0 and rc2 == 0, "A mount command failed")

def umount(args):
    print("Unmounting SD card partitions")
    rc = sudo(["/usr/bin/umount", RPI_MOUNT_BOOT, RPI_MOUNT_ROOT])
    true_or_die(rc == 0, "umount failed")

def mkimage(args):
    mkimage_dir=os.path.join(RASPBERRYPI_TOOLS, "mkimage")
    zImage_path = os.path.join(KERNEL_SRC, "arch/arm/boot/zImage")
    argv=["./imagetool-uncompressed.py", zImage_path]
    print("Uncompressing kernel image to ", mkimage_dir)
    cmd = subprocess.Popen(argv, cwd=mkimage_dir)
    rc = cmd.wait()
    true_or_die(rc == 0, "imagetool-uncompressed.py failed")

def cpimage(args):
    kernel_img=os.path.join(RASPBERRYPI_TOOLS, "mkimage/kernel.img")
    dest=os.path.join(RPI_MOUNT_BOOT, "kernel-new.img")
    print("Copying kernel image to ", dest)
    rc = sudo(["/usr/bin/cp", kernel_img, dest])
    true_or_die(rc == 0, "failed to copy kernel image")

def make(args):
    cross_compile="CROSS_COMPILE=" + CCPREFIX
    arch="ARCH=arm"
    argv = ["/usr/bin/make", "-j8", cross_compile, arch]
    argv.extend(args.options)
    cmd = subprocess.Popen(argv, cwd=KERNEL_SRC)
    rc = cmd.wait()
    true_or_die(rc == 0, "make failed")

def parse(argv):
    p = argparse.ArgumentParser(description="Raspberry Pi dev workflow utility")

    handlers = {
        "mount" : mount,
        "umount" : umount,
        "mkimage" : mkimage,
        "cpimage" : cpimage,
        "make" : make,
    }

    p.add_argument("command", choices=dict.keys(handlers))
    p.add_argument("options", nargs='*')

    # bash and zsh completion
    if has_argcomplete:
        argcomplete.autocomplete(p)

    result = p.parse_args(argv)
    result.handler = handlers[result.command]
    return result

def main():
    args = parse(sys.argv[1:])
    print("Using CCPREFIX: ", CCPREFIX)
    print("Using KERNEL_SRC: ", KERNEL_SRC)
    args.handler(args)
    print("OK")

main()
